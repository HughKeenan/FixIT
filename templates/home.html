{% extends "base.html" %}
{% load static %}
{% load markdown_deux_tags %}
{% block content %}

    <div class="hero-section">
        <div class="hero-bg-shape"></div>
        <div class="container position-relative">
            <div class="hero-title">Tech Help, Made Simple</div>
            <div class="hero-subtitle">Having trouble with tech? <br>Just ask, and Iâ€™ll explain it like you're my grandma. <span style="font-size:1.5rem;">ðŸ˜Š</span></div>
        </div>
    </div>
    <form id="chatForm" method="post" action="{% url 'ask_ai' %}">
        {% csrf_token %}
        <div class="input-group">
            <input type="text" name="user_input" id="userInput" class="form-control" placeholder="Type your question..." required>
            <button type="submit" class="btn btn-primary">Ask</button>
        </div>
    </form>

    <div class="chat-box mb-4" id="chatBox">
        {% if messages %}
            {% for msg in messages %}
                <div class="bot-msg enhanced-response p-3 mb-3 rounded shadow-sm">
                    <div class="d-flex align-items-start mb-2">
                    <span class="me-2" style="font-size: 1rem;">ðŸ¤–</span>
                    <strong class="fs-5 response-sender">FixIT:</strong>
                    </div>
                    <div class="response-text markdown-content">
                        {{ msg.response|markdown:"default" }}
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <div class="user-msg"><strong>{{ msg.question }}</strong></div>
                </div>            
            {% endfor %}
        {% else %}
            <div class="bot-msg"><strong>FixIT:</strong> Hi there! How can I help you today?</div>
        {% endif %}
    </div>

    <script>
        document.getElementById('chatForm').addEventListener('submit', function(e) {
          e.preventDefault();
      
          const input = document.getElementById('userInput');
          const chatBox = document.getElementById('chatBox');
          const question = input.value.trim();
          if (!question) return;
      
          // Show user message aligned right
          const userHTML = `
            <div class="d-flex justify-content-end">
              <div class="user-msg"><strong>${question}</strong></div>
            </div>
          `;
          chatBox.insertAdjacentHTML('afterbegin', userHTML);
      
          fetch('/ask-ai/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new URLSearchParams({ user_input: question })
          })
          .then(res => res.json())
          .then(data => {
            const reply = data.answer || "Sorry, I couldn't understand that.";
            const formattedReply = formatMarkdown(reply);
      
            const botHTML = `
              <div class="bot-msg enhanced-response p-3 mb-3 rounded shadow-sm markdown-content">
                <div class="d-flex align-items-start mb-2">
                  <span class="me-2" style="font-size: 1.5rem;">ðŸ¤–</span>
                  <strong class="text-primary fs-5">FixIT</strong>
                </div>
                <div class="response-text">${formattedReply}</div>
              </div>
            `;
            chatBox.insertAdjacentHTML('afterbegin', botHTML);
          });
      
          input.value = '';
        });
      
        function formatMarkdown(text) {
          return text
            .replace(/\r\n/g, '\n')                          // Normalize line breaks
            .replace(/\n{3,}/g, '\n\n')                      // Collapse 3+ newlines
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
            .replace(/### (.+?)\n/g, '<h3>$1</h3>\n')         // Headers
            .replace(/\n{2}/g, '<br>')                   // Paragraph breaks
            .replace(/\n/g, '<br>')                          // Single line breaks
            .replace(/^(<br>)+|(<br>)+$/g, '');              // Trim leading/trailing <br>
        }
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector('form');
            const input = document.getElementById('userInput');

            form.addEventListener('submit', function () {
                input.setAttribute('readonly', true);  // prevent double submit
                input.value = '';                     // clear input
            });
        });
    </script>
{% endblock %}